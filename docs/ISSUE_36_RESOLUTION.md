# Issue #36 Resolution

## Issue Summary

**Issue #36**: Integration test for clang-tidy with CMake projects (test_iss36.py) was failing on macOS with:

```
CMake Error at CMakeLists.txt:2 (project):
  No cmake_minimum_required command is present.  A line of code such as

    cmake_minimum_required(VERSION 3.28)

  should be added at the top of the file.
```

## Root Cause

Newer versions of CMake (3.27+) require a `cmake_minimum_required()` directive at the beginning of `CMakeLists.txt`. The test was using a minimal CMakeLists.txt that worked with older CMake but failed with newer versions:

**Old CMakeLists.txt** (missing cmake_minimum_required):
```cmake
project(ct_test C)

set(CMAKE_C_STANDARD 99)
set(CMAKE_C_STANDARD_REQUIRED True)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)
add_executable(${PROJECT_NAME} src/ok.c)
list(APPEND FLAGS_DEBUG -g3)

target_compile_options(${PROJECT_NAME} PUBLIC "$<$<CONFIG:DEBUG>:${FLAGS_DEBUG}>")
set_target_properties(${PROJECT_NAME} PROPERTIES OUTPUT_NAME output)
```

## What is Issue #36?

Issue #36 was about ensuring clang-tidy works correctly with CMake-based projects. Specifically:

1. **CMake generates `compile_commands.json`** - This compilation database tells clang-tidy how to compile each source file
2. **clang-tidy uses this database** - When run with `-p=cmake-build-debug`, it reads the compilation database to understand include paths, compiler flags, etc.
3. **The test verifies this workflow** - test_iss36 creates a CMake project, generates the compilation database, and runs clang-tidy

The test ensures that users can successfully use clang-tidy on CMake projects by letting CMake generate the compilation database rather than manually creating it.

## Solution

Add `cmake_minimum_required(VERSION 3.10)` at the top of the CMakeLists.txt template in the test:

```python
# tests/test_iss36.py
CMAKELISTS = """\
cmake_minimum_required(VERSION 3.10)  # ← Added this line
project(ct_test C)

set(CMAKE_C_STANDARD 99)
set(CMAKE_C_STANDARD_REQUIRED True)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)
add_executable(${PROJECT_NAME} src/ok.c)
list(APPEND FLAGS_DEBUG -g3)

target_compile_options(${PROJECT_NAME} PUBLIC "$<$<CONFIG:DEBUG>:${FLAGS_DEBUG}>")
set_target_properties(${PROJECT_NAME} PROPERTIES OUTPUT_NAME output)
"""
```

## Why VERSION 3.10?

CMake 3.10 was chosen because:
1. **Widely available**: Released in 2017, available on all CI platforms (Ubuntu 20.04, Windows latest, macOS latest)
2. **Supports required features**: `CMAKE_EXPORT_COMPILE_COMMANDS` (added in 3.5), generator expressions (added in 2.8.10)
3. **Conservative choice**: Doesn't require cutting-edge CMake versions

## Test Structure

The test_iss36 integration test:

```python
class TestIss36:
    def test_run(cls, expd_output, expd_retcode):
        """ See issue 36, tests cmake"""
        # 1. Create test directory with source file
        os.makedirs(os.path.join(cls.test_dir, "src"), exist_ok=True)
        with open(os.path.join(cls.test_dir, "src", "ok.c"), "w") as f:
            f.write(utils.test_file_strs["ok.c"])

        # 2. Create CMakeLists.txt
        with open(os.path.join(cls.test_dir, "CMakeLists.txt"), "w") as f:
            f.write(CMAKELISTS)

        # 3. Run CMake to generate build files and compile_commands.json
        child = sp.run(
            ["cmake", "-DCMAKE_EXPORT_COMPILE_COMMANDS=ON", "-Wno-dev", cls.test_dir],
            cwd=cls.test_dir,
            stdout=sp.PIPE,
            stderr=sp.PIPE,
        )
        if len(child.stderr) != 0 or child.returncode != 0:
            pytest.fail("Problem occurred when testing iss36:" + child.stderr.decode())

        # 4. Run clang-tidy using CMake-generated compilation database
        output, retcode = utils.integration_test(
            "clang-tidy",
            [os.path.join(cls.test_dir, "src", "ok.c")],
            ["--fix", "--quiet", "-p=cmake-build-debug"],
            cls.test_dir,
        )

        # 5. Verify output
        utils.assert_equal(expd_output, output)
        assert expd_retcode == retcode
```

## Expected Behavior

When the test runs successfully:

```
clang-tidy...............................................................Passed
```

**What it verifies**:
- ✅ CMake successfully generates build files
- ✅ CMake creates `compile_commands.json` with `CMAKE_EXPORT_COMPILE_COMMANDS=ON`
- ✅ clang-tidy can read the compilation database with `-p=cmake-build-debug`
- ✅ clang-tidy successfully analyzes the source file
- ✅ Pre-commit hook exits with code 0 (success)

## Cleanup

The test cleans up generated files in `teardown_class`:

```python
@classmethod
def teardown_class(cls):
    # Delete cmake files generated by issue 36 integration test
    makefile = os.path.join(cls.test_dir, "Makefile")
    cmakecache = os.path.join(cls.test_dir, "CMakeCache.txt")
    cmakefiles = os.path.join(cls.test_dir, "CMakeFiles")
    compile_commands = os.path.join(cls.test_dir, "compile_commands.json")
    cmake_install = os.path.join(cls.test_dir, "cmake_install.cmake")

    generated_files = [makefile, cmakecache, compile_commands, cmake_install]
    for f in generated_files:
        if os.path.exists(f):
            os.remove(f)
    if os.path.exists(cmakefiles):
        shutil.rmtree(cmakefiles)
```

## CI Status

After the fix:
- ✅ **Ubuntu 20.04**: Passing (CMake 3.16.3)
- ✅ **Windows latest**: Passing (CMake 3.28+)
- ✅ **macOS latest**: Passing (CMake 3.28+)

## Related CMake Best Practices

### Always include cmake_minimum_required

**Good**:
```cmake
cmake_minimum_required(VERSION 3.10)
project(MyProject)
# ... rest of CMakeLists.txt
```

**Bad**:
```cmake
project(MyProject)  # Error: No cmake_minimum_required!
```

### Generating Compilation Databases

For clang-tidy and other clang-based tools:

```cmake
# In CMakeLists.txt
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)
```

Or via command line:
```bash
cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=ON .
```

This generates `compile_commands.json`:
```json
[
  {
    "directory": "/path/to/build",
    "command": "/usr/bin/cc -I/include/path -std=c99 -o file.o -c ../src/file.c",
    "file": "../src/file.c"
  }
]
```

### Using clang-tidy with CMake Projects

```bash
# Generate build files and compilation database
cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -B build

# Run clang-tidy using the database
clang-tidy src/file.c -p=build
```

Or with pre-commit:
```yaml
repos:
  - repo: https://github.com/pocc/pre-commit-hooks
    rev: v1.3.5
    hooks:
      - id: clang-tidy
        args: ['-p=build']  # Use CMake-generated compilation database
```

## Issue Timeline

1. **Original Issue #36**: User reported clang-tidy not working with CMake projects
2. **Fix**: Added test_iss36.py to verify CMake integration works
3. **Regression**: Test started failing on newer CMake versions (3.27+) requiring cmake_minimum_required
4. **Resolution**: Added `cmake_minimum_required(VERSION 3.10)` to test CMakeLists.txt
5. **Current Status**: ✅ Test passing on all platforms

## Related Documentation

- [Cross-Platform Testing Fixes](CROSS_PLATFORM_FIXES.md)
- [CMake Documentation: cmake_minimum_required](https://cmake.org/cmake/help/latest/command/cmake_minimum_required.html)
- [CMake Documentation: CMAKE_EXPORT_COMPILE_COMMANDS](https://cmake.org/cmake/help/latest/variable/CMAKE_EXPORT_COMPILE_COMMANDS.html)
- [Clang Documentation: JSON Compilation Database Format](https://clang.llvm.org/docs/JSONCompilationDatabase.html)
