name: test macos latest
on: [push]
jobs:
  build:
    runs-on: [macos-latest]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Add llvm utils clang-format and clang-tidy to path
        run: echo "$(brew --prefix llvm)/bin" >> $GITHUB_PATH
      - name: Configure macOS SDK for clang-tidy
        run: |
          echo "SDKROOT=$(xcrun --show-sdk-path)" >> $GITHUB_ENV
          echo "CPATH=$(xcrun --show-sdk-path)/usr/include" >> $GITHUB_ENV
      - name: Install 5 hooks, python3, llvm already includes clang-tidy, clang-format
        run: brew install uncrustify cppcheck oclint iwyu
      - name: Fix OCLint dylib paths
        run: .github/scripts/fix-oclint-macos.sh
      - name: Install pip dependencies
        run: pip3 install --break-system-packages cpplint pytest pre-commit
      - name: Install hooks locally
        run: pip3 install --break-system-packages .
      - name: Get command versions
        run: |
          clang-format --version
          clang-tidy --version
          cppcheck --version
          cpplint --version
          include-what-you-use --version
          oclint --version
      - name: Get python library versions
        run: |
          pytest --version
          pre-commit --version
      - name: Run tests
        run: python3 -m pytest -x -vvv
